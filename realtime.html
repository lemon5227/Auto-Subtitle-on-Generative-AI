<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Transcription - AI Studio</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
      background-color: #F5F5F7;
      color: #1D1D1F;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes popIn {
        0% { opacity: 0; transform: scale(0.9) translateY(10px); }
        60% { transform: scale(1.02) translateY(-2px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
        100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
    }
    @keyframes expandOpen {
        from { opacity: 0; transform: scaleY(0.95); max-height: 0; }
        to { opacity: 1; transform: scaleY(1); max-height: 400px; }
    }

    .glass-nav {
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        animation: fadeIn 0.5s ease-out;
    }

    .apple-card {
        background: #FFFFFF;
        border-radius: 18px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.02);
        overflow: hidden;
        animation: fadeIn 0.6s ease-out;
    }

    .apple-input {
        background: #F5F5F7;
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        font-size: 15px;
        color: #1D1D1F;
    }

    .apple-input:focus {
        background: #FFFFFF;
        border-color: #0071E3;
        box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
        outline: none;
        transform: scale(1.01);
    }

    .apple-select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
    }

    /* Voice Memo Style Button */
    .record-btn {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: #FF3B30;
        border: 4px solid #FFFFFF;
        box-shadow: 0 0 0 2px #FF3B30, 0 8px 24px rgba(255, 59, 48, 0.3);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Springy */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        z-index: 10;
    }

    .record-btn:hover {
        transform: scale(1.1);
    }
    
    .record-btn.recording {
        border-radius: 16px;
        transform: scale(0.9);
        background: #FF3B30;
        box-shadow: 0 0 0 2px #FF3B30, 0 4px 12px rgba(255, 59, 48, 0.2);
    }
    
    .record-btn svg {
        width: 24px;
        height: 24px;
        color: white;
        transition: all 0.2s;
    }
    
    .record-btn.recording svg {
        opacity: 0;
    }

    /* Transcript Styles */
    .subtitle-area { 
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      padding: 24px;
      background: #FFFFFF;
      scroll-behavior: smooth;
    }
    
    .subtitle-item {
        margin-bottom: 20px;
        animation: popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: left bottom;
    }

    .bubble {
        background: #F2F2F7;
        padding: 12px 18px;
        border-radius: 18px;
        border-top-left-radius: 4px;
        display: inline-block;
        max-width: 85%;
        color: #1D1D1F;
        font-size: 16px;
        line-height: 1.5;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .bubble.translated {
        background: #E8F2FF;
        color: #0040DD;
        margin-top: 4px;
        border-top-left-radius: 18px;
        border-bottom-left-radius: 4px;
    }
    
    .timestamp {
        font-size: 11px;
        color: #86868b;
        margin-bottom: 4px;
        margin-left: 4px;
        font-weight: 500;
    }

    .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid #FF3B30;
        opacity: 0;
        pointer-events: none;
    }

    /* Multiple Pulse Rings */
    .recording .pulse-ring { animation: pulse 2s infinite; }
    .recording .pulse-ring:nth-child(2) { animation-delay: 0.5s; }
    .recording .pulse-ring:nth-child(3) { animation-delay: 1s; }

    /* Switch Toggle */
    .apple-switch {
        position: relative;
        display: inline-block;
        width: 42px;
        height: 24px;
    }
    .apple-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #E5E5EA;
        transition: .4s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s cubic-bezier(0.25, 1, 0.5, 1);
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    input:checked + .slider { background-color: #34C759; }
    input:checked + .slider:before { transform: translateX(18px); }

    /* Settings Panel Animation */
    .animation-expand {
        animation: expandOpen 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: top;
    }

  </style>
</head>
<body class="pb-20">

  <!-- Navigation -->
  <nav class="glass-nav sticky top-0 z-50 w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-14">
        <div class="flex items-center space-x-4">
          <a href="index.html" class="flex items-center space-x-2 text-gray-900 hover:opacity-70 transition-opacity">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
              <span class="font-medium text-sm">Back</span>
          </a>
          <div class="h-4 w-px bg-gray-300"></div>
          <span class="font-semibold text-sm">Realtime Transcription</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">

    <!-- Controls Card -->
    <div class="apple-card p-8 mb-8 flex flex-col items-center text-center relative overflow-visible">

        <!-- Recording Button Area -->
        <div class="mb-8 relative flex flex-col items-center justify-center">
             <button id="micBtn" class="record-btn relative z-10">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.5v1.5m0-1.5a6 6 0 0 1-6-6v-3a6 6 0 0 1 12 0v3a6 6 0 0 1-6 6zm0-14.5a3 3 0 0 0-3 3v3a3 3 0 0 0 6 0v-3a3 3 0 0 0-3-3z"/>
                </svg>
                 <div class="pulse-ring"></div>
                 <div class="pulse-ring"></div>
                 <div class="pulse-ring"></div>
             </button>
             <p id="micStatus" class="mt-4 text-sm font-medium text-gray-500 transition-colors">Tap to Record</p>
        </div>

        <!-- Settings Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
            <div class="text-left">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 block">Source Language</label>
                <select id="languageSelect" class="apple-input apple-select w-full" onchange="updateModelOptions()">
                    <option value="zh">Chinese</option>
                    <option value="en">English</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                </select>
            </div>
            
            <div class="text-left">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 block">Model</label>
                <select id="modelSelect" class="apple-input apple-select w-full">
                    <option value="large-v3-turbo">large-v3-turbo (Fastest)</option>
                    <option value="small">small</option>
                    <option value="base">base</option>
                </select>
            </div>
        </div>

        <!-- Advanced Toggles -->
        <div class="mt-8 w-full max-w-2xl border-t border-gray-100 pt-6 flex flex-col md:flex-row justify-between gap-6">
            
            <!-- Translation Toggle -->
            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl flex-1">
                <div class="mr-4">
                    <h4 class="text-sm font-semibold text-gray-900">Realtime Translation</h4>
                    <p class="text-xs text-gray-500 mt-1">Translate to target language instantly</p>
                </div>
                <label class="apple-switch">
                    <input type="checkbox" id="enableTranslation" onchange="toggleTranslationSettings()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Refinement Toggle -->
            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl flex-1">
                <div class="mr-4">
                    <h4 class="text-sm font-semibold text-gray-900">Smart Refinement</h4>
                    <p class="text-xs text-gray-500 mt-1">Fix grammar & punctuation (Qwen)</p>
                </div>
                <label class="apple-switch">
                    <input type="checkbox" id="enableRefinement" onchange="toggleRefinementSettings()">
                    <span class="slider"></span>
                </label>
            </div>

        </div>

        <!-- Hidden Settings Panels -->
        <div id="translationSettings" class="hidden w-full max-w-2xl mt-4 bg-blue-50 p-4 rounded-xl border border-blue-100 text-left animation-expand">
            <label class="text-xs font-semibold text-blue-600 uppercase tracking-wide mb-2 block">Translate To</label>
            <select id="targetLanguage" class="apple-input apple-select w-full bg-white border-blue-200">
                <option value="en">English</option>
                <option value="zh">Chinese</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
            </select>
        </div>

        <div id="refinementSettings" class="hidden w-full max-w-2xl mt-4 bg-purple-50 p-4 rounded-xl border border-purple-100 text-left animation-expand">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label class="text-xs font-semibold text-purple-600 uppercase tracking-wide mb-2 block">Refinement Model</label>
                    <select id="refinementModel" class="apple-input apple-select w-full bg-white border-purple-200">
                        <option value="Qwen/Qwen3-1.7B" selected>Qwen3-1.7B (Recommended)</option>
                        <option value="Qwen/Qwen3-0.6B">Qwen3-0.6B (Fast)</option>
                    </select>
                 </div>
                 <div class="flex flex-col gap-2 pt-6">
                     <label class="flex items-center text-sm text-gray-700">
                         <input type="checkbox" id="fixPunctuation" class="mr-2 rounded text-purple-600" checked> Punctuation
                     </label>
                     <label class="flex items-center text-sm text-gray-700">
                         <input type="checkbox" id="fixGrammar" class="mr-2 rounded text-purple-600" checked> Grammar
                     </label>
                 </div>
            </div>
        </div>
    </div>

    <!-- Transcript Area -->
    <div class="apple-card">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
            <div class="flex items-center space-x-3">
                <h3 class="font-semibold text-gray-900">Live Transcript</h3>
                <span id="subtitleCount" class="px-2 py-1 bg-white border border-gray-200 text-xs rounded-md text-gray-500 font-mono">0 lines</span>
            </div>
            <div class="flex space-x-2">
                <button id="clearBtn" class="text-xs font-medium text-gray-600 hover:text-red-500 transition-colors px-3 py-1.5 hover:bg-red-50 rounded-lg">Clear</button>
                <button id="saveBtn" class="text-xs font-medium text-white bg-gray-900 px-3 py-1.5 rounded-lg hover:bg-gray-800 transition-colors">Save</button>
            </div>
        </div>

        <div id="subtitleArea" class="subtitle-area">
            <div class="h-full flex flex-col items-center justify-center text-center text-gray-400 py-20">
                <svg class="w-12 h-12 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <p class="text-sm">Transcription will appear here...</p>
            </div>
        </div>
    </div>

  </main>

  <!-- Save Modal -->
  <div id="saveModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden z-[100] flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Save Transcript</h3>
          <div class="space-y-4">
              <div>
                  <label class="block text-xs font-semibold text-gray-500 mb-1">Filename</label>
                  <input type="text" id="filenameInput" class="apple-input w-full" value="transcript" placeholder="transcript">
              </div>
              <div>
                  <label class="block text-xs font-semibold text-gray-500 mb-1">Format</label>
                  <select id="formatSelect" class="apple-input apple-select w-full">
                      <option value="txt">Text (.txt)</option>
                      <option value="vtt">WebVTT (.vtt)</option>
                      <option value="srt">SRT (.srt)</option>
                  </select>
              </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
              <button id="cancelSaveBtn" class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
              <button id="confirmSaveBtn" class="px-4 py-2 text-sm font-medium text-white bg-[#0071E3] hover:bg-[#0077ED] rounded-lg">Save</button>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
  <script>
    // Main Application Logic
    const micBtn = document.getElementById('micBtn');
    const micStatus = document.getElementById('micStatus');
    const subtitleArea = document.getElementById('subtitleArea');
    const languageSelect = document.getElementById('languageSelect');
    const modelSelect = document.getElementById('modelSelect');

    let listening = false;
    let socket = null;
    let mediaStream = null;
    let audioContext = null;
    let audioProcessor = null;
    let subtitles = [];
    let currentSubtitleId = 0;

    function init() {
        // Initialize Model Options
        updateModelOptions();
        
        // Setup Listeners
        micBtn.addEventListener('click', toggleListening);
        document.getElementById('clearBtn').addEventListener('click', clearSubtitles);
        document.getElementById('saveBtn').addEventListener('click', () => document.getElementById('saveModal').classList.remove('hidden'));
        document.getElementById('cancelSaveBtn').addEventListener('click', () => document.getElementById('saveModal').classList.add('hidden'));
        document.getElementById('confirmSaveBtn').addEventListener('click', saveSubtitles);

        if (window.io) {
            setupSocket();
        }
    }

    function updateModelOptions() {
        const lang = languageSelect.value;
        const current = modelSelect.value;
        modelSelect.innerHTML = '';
        
        const models = [
            { val: 'large-v3-turbo', text: 'large-v3-turbo (Recommended)' },
            { val: 'large-v3', text: 'large-v3 (Accurate)' },
            { val: 'small', text: 'small (Fast)' },
            { val: 'base', text: 'base' }
        ];
        
        if (lang === 'zh') models.push({ val: 'sensevoice', text: 'SenseVoice (Chinese)' });
        if (lang === 'en') models.push({ val: 'distil-medium.en', text: 'distil-medium.en (English)' });
        
        models.forEach(m => modelSelect.add(new Option(m.text, m.val)));
        if (Array.from(modelSelect.options).some(o => o.value === current)) modelSelect.value = current;
    }

    function toggleTranslationSettings() {
        const el = document.getElementById('translationSettings');
        document.getElementById('enableTranslation').checked ? el.classList.remove('hidden') : el.classList.add('hidden');
    }

    function toggleRefinementSettings() {
        const el = document.getElementById('refinementSettings');
        document.getElementById('enableRefinement').checked ? el.classList.remove('hidden') : el.classList.add('hidden');
    }

    // Socket & Audio Logic
    function setupSocket() {
        socket = io(window.location.origin, { transports: ['polling', 'websocket'] });
        socket.on('connect', () => console.log('Connected'));
        socket.on('disconnect', () => stopListeningUI());
        socket.on('transcription', (payload) => {
            if(payload?.text) addSubtitle(payload.text, payload.timestamp);
        });
    }

    async function toggleListening() {
        if (listening) {
            await stopListening();
        } else {
            await startListening();
        }
    }

    async function startListening() {
        try {
            micBtn.disabled = true;
            micStatus.textContent = 'Connecting...';

            if (!socket.connected) socket.connect();

            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, sampleRate: 16000 } });

            socket.emit('start_transcription', {
                model: modelSelect.value,
                language: languageSelect.value
            }, (resp) => {
                if (resp?.status !== 'success') throw new Error(resp?.message || 'Failed to start');
            });

            startAudioStreaming();
            startListeningUI();
        } catch (e) {
            console.error(e);
            alert('Could not start recording: ' + e.message);
            micBtn.disabled = false;
        }
    }

    async function stopListening() {
        stopListeningUI();
        cleanupAudio();
        if (socket?.connected) socket.emit('stop_transcription', {});
    }

    function startListeningUI() {
        listening = true;
        micBtn.disabled = false;
        micBtn.classList.add('recording');
        micStatus.textContent = 'Recording...';
        micStatus.className = 'mt-4 text-sm font-medium text-red-500 animate-pulse';
    }

    function stopListeningUI() {
        listening = false;
        micBtn.disabled = false;
        micBtn.classList.remove('recording');
        micStatus.textContent = 'Tap to Record';
        micStatus.className = 'mt-4 text-sm font-medium text-gray-500';
    }

    function startAudioStreaming() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(mediaStream);
        audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
        
        audioProcessor.onaudioprocess = (e) => {
            if (!listening || !socket.connected) return;
            const input = e.inputBuffer.getChannelData(0);
            const pcm = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
                const s = Math.max(-1, Math.min(1, input[i]));
                pcm[i] = s < 0 ? s * 32768 : s * 32767;
            }
            // Convert to Base64 manually to avoid external deps if possible, or send raw
            // Ideally server expects b64
            const binary = String.fromCharCode.apply(null, new Uint8Array(pcm.buffer));
            socket.emit('audio_chunk', { audio: btoa(binary), sampleRate: audioContext.sampleRate });
        };
        
        source.connect(audioProcessor);
        audioProcessor.connect(audioContext.destination);
    }

    function cleanupAudio() {
        if (audioProcessor) { audioProcessor.disconnect(); audioProcessor = null; }
        if (audioContext) { audioContext.close(); audioContext = null; }
        if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
    }

    // Transcript Logic
    async function addSubtitle(text, timestamp = Date.now()) {
        // Clear placeholder
        if (subtitles.length === 0) subtitleArea.innerHTML = '';

        const id = ++currentSubtitleId;
        const timeStr = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Translation & Refinement Placeholders
        let displayText = text;
        let translatedText = null;
        
        // Create DOM
        const item = document.createElement('div');
        item.className = 'subtitle-item text-left';
        item.dataset.id = id;
        
        const dateDiv = document.createElement('div');
        dateDiv.className = 'timestamp';
        dateDiv.innerText = timeStr;
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerText = displayText;
        
        item.appendChild(dateDiv);
        item.appendChild(bubble);
        subtitleArea.appendChild(item);
        subtitleArea.scrollTop = subtitleArea.scrollHeight;
        
        // Process Translation
        if (document.getElementById('enableTranslation').checked) {
            const target = document.getElementById('targetLanguage').value;
            // This would be an async fetch usually
            try {
                const resp = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, source_lang: languageSelect.value, target_lang: target, use_qwen: false })
                });
                const data = await resp.json();
                if (data.translated_text) {
                    const tBubble = document.createElement('div');
                    tBubble.className = 'bubble translated mt-2 block';
                    tBubble.innerText = data.translated_text;
                    item.appendChild(tBubble);
                    translatedText = data.translated_text;
                }
            } catch(e) { console.error(e); }
        }

        // Process Refinement
        if (document.getElementById('enableRefinement').checked) {
            // Async Refine
            try {
                const resp = await fetch('/api/refine_subtitle', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({
                         text,
                         model: document.getElementById('refinementModel').value,
                         options: { fix_punctuation: true, fix_grammar: true }
                     })
                });
                const data = await resp.json();
                if (data.refined_text) {
                    bubble.innerHTML = data.refined_text + ' <span class="text-green-500 ml-1 text-xs">âœ¨</span>';
                    displayText = data.refined_text;
                }
            } catch(e) { console.error(e); }
        }

        subtitles.push({ id, text: displayText, translation: translatedText, timestamp });
        document.getElementById('subtitleCount').innerText = `${subtitles.length} lines`;
    }

    function clearSubtitles() {
        subtitleArea.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center text-gray-400 py-20"><svg class="w-12 h-12 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg><p class="text-sm">Transcription will appear here...</p></div>`;
        subtitles = [];
        document.getElementById('subtitleCount').innerText = '0 lines';
    }
    
    function saveSubtitles() {
        const filename = document.getElementById('filenameInput').value || 'transcript';
        const format = document.getElementById('formatSelect').value;
        
        let content = '';
        subtitles.forEach((s, i) => {
            const start = new Date(s.timestamp).toISOString().substr(11, 8);
            const end = new Date(s.timestamp + 5000).toISOString().substr(11, 8);

            if (format === 'vtt') {
                if (i === 0) content += 'WEBVTT\n\n';
                content += `${i+1}\n${start}.000 --> ${end}.000\n${s.text}\n`;
                if (s.translation) content += `${s.translation}\n`;
                content += '\n';
            } else if (format === 'srt') {
                content += `${i+1}\n${start},000 --> ${end},000\n${s.text}\n`;
                if (s.translation) content += `${s.translation}\n`;
                content += '\n';
            } else {
                content += `[${start}] ${s.text}\n`;
                if (s.translation) content += `       ${s.translation}\n`;
                content += '\n';
            }
        });
        
        const blob = new Blob([content], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        document.getElementById('saveModal').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>