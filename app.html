<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auto Subtitle on Generative AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#2563EB', accent: '#06B6D4', surface: '#FFFFFF', bg: '#F8FAFC', muted: '#64748B' },
                    boxShadow: { 'card-sm': '0 6px 18px rgba(15,23,36,0.06)' },
                    borderRadius: { card: '12px' }
                }
            }
        }
    </script>
    <style>
        :root{
            /* 温馨和谐的暖色系配色（柔和珊瑚 + 蜜桃 + 奶油） */
            --primary: #FF7A6A;    /* 珊瑚主色 */
            --accent:  #FFD166;    /* 温暖黄色点缀 */
            --surface: #FFFFFF;    /* 卡片表面 */
            --bg:      #FFF8F3;    /* 页面背景（奶油色） */
            --muted:   #7C6B66;    /* 柔和灰褐 */
            --card-border: #FFE8E1; /* 卡片边框（淡珊瑚） */
        }
        body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg); color: #0f172a; }
        .text-shadow { text-shadow: 0 2px 6px rgba(0,0,0,0.12); }
        #subtitleOverlay { pointer-events: none; }
        .subtitle-editor { min-height: 160px; padding: 12px; }
        /* Flat card style */
        .card-flat { background: var(--surface); border: 1px solid var(--card-border); border-radius: 12px; box-shadow: none; }
        .accent-btn { background: var(--accent); color: white; }
        .primary-btn { background: var(--primary); color: white; }
    /* icons sized in em so they follow surrounding font-size and align on baseline */
    .icon { width: 1em; height: 1em; vertical-align: -0.125em; margin-right: 0.5rem; fill: currentColor; opacity: .95; display: inline-block; }
    /* ensure icons render crisply */
    .icon path, .icon rect, .icon circle { shape-rendering: geometricPrecision; }
    /* Fine-tune icon baseline for specific contexts */
    /* Header icons: slightly less negative offset so they sit nicely with larger headings */
    h1 .icon, .text-2xl .icon { vertical-align: -0.08em; }
    /* Buttons and small controls: keep icons centered with text */
    button .icon, .flex.items-center .icon, .px-3 .icon { vertical-align: -0.125em; }
    /* Micro-interactions */
    .primary-btn, .accent-btn { transition: transform .12s ease, box-shadow .12s ease; }
    .primary-btn:hover, .accent-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .primary-btn:active, .accent-btn:active { transform: translateY(0); box-shadow: none; }
    button:focus { outline: 3px solid rgba(255,122,106,0.12); outline-offset: 2px; }
    /* 装饰性插画样式 */
    .decor-illustration { width: 160px; height: 56px; display: inline-block; }
    .decor-small { width: 72px; height: 48px; opacity: .9 }
    /* fix decorations to viewport edges so they are always visible */
    .decor-abs { position: fixed; pointer-events: none; opacity: .18; z-index: 0; transform: translateZ(0); }
    /* main content should sit above decorations */
    .page-content { position: relative; z-index: 1; }
    /* hide large decorations on small screens */
    @media (max-width: 768px) { .decor-abs { display: none; } }
    /* File input button styling for Controls panel */
    .file-input-wrapper { display:block; }
    .file-btn { display:flex; align-items:center; gap:0.5rem; padding:0.5rem 0.75rem; border:1px solid var(--card-border); background:var(--surface); border-radius:8px; cursor:pointer; }
    .file-btn:hover { box-shadow: 0 6px 14px rgba(15,23,36,0.06); transform: translateY(-1px); }
    .file-name { margin-left:auto; font-size:0.85rem; color:var(--muted); }
    .file-label { font-size:0.95rem; color: #2b2b2b; }
    /* visually hide the native file input while keeping it accessible */
    .file-input-native { position: absolute; left: -9999px; width:1px; height:1px; overflow:hidden; }
    </style>
    <style>
    /* model list ready badge */
    .model-badge { display:inline-flex; align-items:center; gap:0.35rem; padding:0.18rem 0.45rem; border-radius:999px; background:#ECFDF5; color:#065F46; font-size:0.8rem; border:1px solid #D1FAE5; }
    .model-action-group { display:flex; align-items:center; gap:0.5rem; }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- decorative illustrations on sides (inline SVG to avoid CDN/static issues) -->
        <svg class="decor-abs" style="left: -60px; top: 40px; width:220px; height:220px;" aria-hidden viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="in-g1" x1="0" x2="1"><stop offset="0%" stop-color="#FFB86B"/><stop offset="100%" stop-color="#FF7A59"/></linearGradient>
                <linearGradient id="in-g2" x1="0" x2="1"><stop offset="0%" stop-color="#FFD8B5"/><stop offset="100%" stop-color="#FFF6EE"/></linearGradient>
            </defs>
            <path d="M40 200C20 150 10 110 60 80C110 50 180 40 230 70C280 100 320 160 270 210C220 260 120 250 40 200Z" fill="url(#in-g2)" opacity="0.95"/>
            <g transform="translate(60,40) scale(0.7)">
                <circle cx="120" cy="120" r="96" fill="url(#in-g1)"/>
                <circle cx="120" cy="120" r="72" fill="#FFF6EE" opacity="0.9"/>
                <path d="M110 96 L170 128 L110 160 Z" fill="#FF7A59"/>
                <path d="M110 96 L170 128 L110 160 Z" fill-opacity="0" stroke="#FFB86B" stroke-width="2"/>
            </g>
        </svg>

        <svg class="decor-abs" style="right: 12px; bottom: 12px; width:280px; height:160px; opacity: .96;" aria-hidden viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="in-rg1" x1="0" x2="1"><stop offset="0%" stop-color="#FF7A59"/><stop offset="100%" stop-color="#FFB86B"/></linearGradient>
            </defs>
            <rect x="20" y="40" rx="20" ry="20" width="260" height="160" fill="url(#in-rg1)" opacity="0.95"/>
            <g transform="translate(40,80)">
                <rect x="0" y="0" width="120" height="72" rx="8" fill="#FFF6EE"/>
                <path d="M16 36 L48 24 V48 L16 36Z" fill="#FF7A59"/>
            </g>
            <path d="M120 220 C140 200 180 210 200 190 C220 170 260 180 280 160" stroke="#FFF6EE" stroke-width="6" fill="none" stroke-linecap="round" opacity="0.9"/>
        </svg>
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-semibold"><svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="2" y="3" width="20" height="18" rx="3"></rect></g><g fill="var(--primary)"><path d="M9 8v8l6-4-6-4z"></path></g></svg>Auto Subtitle on Generative AI</h1>
            <div class="flex items-center gap-3">
                <div class="text-sm text-slate-500">Status: <span id="status">Idle</span></div>
                <button id="openModelModal" class="px-3 py-2 bg-white border rounded flex items-center gap-2"><svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="3" y="3" width="18" height="6" rx="1"></rect></g><g fill="var(--primary)"><path d="M7 13h10v6H7z"></path></g></svg><span>Model</span></button>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <main class="lg:col-span-2 space-y-6">
                <section class="card-flat p-4">
                    <div class="flex items-center justify-between mb-3"><h2 class="text-lg font-medium"><svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="2" y="4" width="20" height="14" rx="2"></rect></g><g fill="var(--primary)"><path d="M8 7v10l8-5-8-5z"></path></g></svg>Video Player & Preview</h2>
                        <svg class="decor-small decor-abs" style="right:12px; top:-6px;" viewBox="0 0 160 56" aria-hidden><g fill="var(--accent)"><circle cx="24" cy="28" r="12"></circle><rect x="44" y="12" width="84" height="32" rx="6"></rect></g><g fill="var(--primary)"><path d="M52 24h40v8H52z"></path></g></svg></div>
                    <div id="playerContainer" class="relative">
                        <video id="videoPlayer" class="w-full rounded bg-black" controls playsinline crossorigin></video>
                        <div id="subtitleOverlay" class="absolute left-0 right-0 bottom-8 text-center text-white text-shadow text-lg px-4 hidden" style="white-space:pre-line;"></div>
                    </div>
                </section>

                <section class="card-flat p-4">
                    <h2 class="text-lg font-medium mb-3"><svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="2" y="4" width="20" height="14" rx="2"></rect></g><g fill="var(--primary)"><path d="M6 9h12v2H6zM6 13h8v2H6z"></path></g></svg>Subtitle Editor</h2>
                    <textarea id="originalSubtitles" class="w-full p-3 border rounded mb-3" rows="6" placeholder="Original subtitles (VTT)"></textarea>
                    <textarea id="translatedSubtitles" class="w-full p-3 border rounded" rows="6" placeholder="Translated subtitles"></textarea>
                </section>
            </main>

            <aside class="space-y-6">
                <div class="card-flat p-4">
                    <h3 class="font-medium mb-3"><svg class="icon" viewBox="0 0 24 24" aria-hidden><path d="M12 2a2 2 0 0 1 2 2v1h2v2h-2v1a2 2 0 1 1-4 0V7H8V5h2V4a2 2 0 0 1 2-2z"></path></svg>Controls</h3>
                    <label class="block text-sm mb-1">Video File</label>
                    <div class="file-input-wrapper mb-3 relative">
                        <label for="videoFile" class="file-btn" tabindex="0">
                            <!-- folder icon -->
                            <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"></path></g></svg>
                            <span class="file-label">Choose file...</span>
                            <span id="chosenFileName" class="file-name">No file</span>
                            <input id="videoFile" class="file-input-native" type="file" />
                        </label>
                    </div>
                    <label class="block text-sm mb-1">Video URL (YouTube)</label>
                    <input id="videoUrlInput" type="text" class="w-full p-2 border rounded mb-3" placeholder="https://www.youtube.com/watch?v=..." />
                    <div class="flex gap-2 mb-3">
                        <button id="fetchBtn" class="flex-1 primary-btn py-2 rounded"> <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="10" y="2" width="10" height="6" rx="1"></rect></g><g fill="var(--primary)"><path d="M12 6v10M9 9l3 3 3-3"></path></g></svg>Fetch</button>
                        <button id="previewBtn" class="flex-1 primary-btn py-2 rounded flex items-center justify-center gap-2 text-center"> 
                            <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="3" y="5" width="18" height="14" rx="2"></rect></g><g fill="var(--primary)"><path d="M8 8v8l8-4-8-4z"></path></g></svg>
                            <span>Preview</span>
                        </button>
                    </div>
                    <button id="generateBtn" class="w-full accent-btn py-2 rounded"> <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><circle cx="12" cy="7" r="4"></circle></g><g fill="var(--primary)"><path d="M6 18c1-2 4-3 6-3s5 1 6 3v1H6v-1z"></path></g></svg>Generate Subtitles</button>
                </div>

                <div class="card-flat p-4">
                    <h3 class="font-medium mb-3">Subtitle Style</h3>
                    <label class="block text-sm mb-1">Color</label>
                    <input id="subtitleColor" type="color" value="#ffffff" class="mb-3" />
                    <label class="block text-sm mb-1">Size</label>
                    <input id="subtitleSize" type="range" min="12" max="48" value="24" class="w-full" />
                </div>

                <div class="card-flat p-4">
                    <h3 class="font-medium mb-3">Quick Actions</h3>
                    <button id="downloadOriginalBtn" class="w-full mb-2 border py-2 rounded"> <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="6" y="3" width="12" height="6" rx="1"></rect></g><g fill="var(--primary)"><path d="M12 7v10M9 10l3 3 3-3"></path></g></svg>Download Original</button>
                    <button id="downloadTranslatedBtn" class="w-full border py-2 rounded"> <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="6" y="3" width="12" height="6" rx="1"></rect></g><g fill="var(--primary)"><path d="M12 7v10M9 10l3 3 3-3"></path></g></svg>Download Translated</button>
                </div>

                <div class="card-flat p-4">
                    <label class="block text-sm mb-1">Choose Model</label>
                    <select id="modelSelect" class="w-full p-2 border rounded mb-3"></select>
                    <div class="flex items-center gap-2 mb-3"><input id="useFasterCheck" type="checkbox"/> <label class="text-sm">Use faster-whisper (GPU)</label></div>
                    <label class="block text-sm mb-1">Translate From</label>
                    <select id="sourceLangSelect" class="w-full p-2 border rounded mb-3"></select>
                    <label class="block text-sm mb-1">Translate To</label>
                    <select id="targetLangSelect" class="w-full p-2 border rounded mb-3"></select>
                    <label class="block text-sm mb-1">Subtitle Mode</label>
                    <select id="subtitleModeSelect" class="w-full p-2 border rounded">
                        <option value="original">Original</option>
                        <option value="translated">Translated</option>
                        <option value="bilingual">Bilingual</option>
                    </select>
                </div>
            </aside>
        </div>

    <div class="mt-6 grid lg:grid-cols-2 gap-4">
            <div>
                <h4 class="font-medium mb-2">Original Subtitles</h4>
                <div id="originalSubtitlesPane" class="subtitle-editor bg-white border rounded" contenteditable="true"></div>
            </div>
            <div>
                <h4 class="font-medium mb-2">Translated Subtitles</h4>
                <div id="translatedSubtitlesPane" class="subtitle-editor bg-white border rounded" contenteditable="true"></div>
            </div>
        </div>
    </div>

    <!-- Model Management Modal (simple) -->
    <div id="modelManagementModal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black/40">
    <div class="card-flat w-[900px] max-w-full rounded-lg overflow-hidden">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 class="font-medium">Model Management</h3>
                <button id="closeModelModal" class="text-muted flex items-center gap-2"><svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--primary)"><rect x="5" y="5" width="14" height="14" rx="2"></rect></g><g fill="var(--accent)"><path d="M9 9l6 6M15 9l-6 6" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>Close</button>
            </div>
            <div class="p-4 grid grid-cols-2 gap-4">
                <div>
                    <h6 class="mb-2">Transcription Models (Whisper)</h6>
                    <ul id="whisperModelList" class="space-y-2"></ul>
                </div>
                <div>
                    <h6 class="mb-2">Translation Models</h6>
                    <ul id="translationModelList" class="space-y-2"></ul>
                </div>
            </div>
            <div class="p-4 border-t text-right"><button id="closeModelModal2" class="px-3 py-2 rounded bg-gray-100 flex items-center gap-2"><svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="var(--accent)"><rect x="5" y="5" width="14" height="14" rx="2"></rect></g><g fill="var(--primary)"><path d="M9 9l6 6M15 9l-6 6" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>Close</button></div>
        </div>
    </div>

    <script>
        // --- DOM refs ---
        const videoFile = document.getElementById('videoFile');
        const videoUrlInput = document.getElementById('videoUrlInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const previewBtn = document.getElementById('previewBtn');
        const generateBtn = document.getElementById('generateBtn');
        const videoPlayer = document.getElementById('videoPlayer');
        const subtitleOverlay = document.getElementById('subtitleOverlay');
        const originalSubtitles = document.getElementById('originalSubtitles');
        const translatedSubtitles = document.getElementById('translatedSubtitles');
        const originalSubtitlesPane = document.getElementById('originalSubtitlesPane');
        const translatedSubtitlesPane = document.getElementById('translatedSubtitlesPane');
        const downloadOriginalBtn = document.getElementById('downloadOriginalBtn');
        const downloadTranslatedBtn = document.getElementById('downloadTranslatedBtn');
        const subtitleColor = document.getElementById('subtitleColor');
        const subtitleSize = document.getElementById('subtitleSize');
        const subtitleModeSelect = document.getElementById('subtitleModeSelect');
        const modelSelect = document.getElementById('modelSelect');
        const useFasterCheck = document.getElementById('useFasterCheck');
        const sourceLangSelect = document.getElementById('sourceLangSelect');
        const targetLangSelect = document.getElementById('targetLangSelect');
        const openModelModal = document.getElementById('openModelModal');
        const modelManagementModal = document.getElementById('modelManagementModal');
        const closeModelModal = document.getElementById('closeModelModal');
        const closeModelModal2 = document.getElementById('closeModelModal2');

    // file chooser nicer UI elements
    const chosenFileNameEl = document.getElementById('chosenFileName');

        let originalVtt = '';
        let translatedVtt = '';
        let ytPlayer = null;
        // ensure chosen file name reflects selection
        if (videoFile) {
            videoFile.addEventListener('change', (e)=>{
                try {
                    const f = (videoFile.files && videoFile.files[0]);
                    if (f && chosenFileNameEl) {
                        chosenFileNameEl.innerText = f.name;
                        // when a local file is chosen, clear any prior serverSavedVideoPath
                        serverSavedVideoPath = null;
                        document.getElementById('status').innerText = 'Local file selected: ' + f.name;
                    } else if (chosenFileNameEl) {
                        chosenFileNameEl.innerText = 'No file';
                    }
                } catch (err) {
                    console.warn('File select update failed', err);
                }
            });
            // allow keyboard activation of the label
            const fileLabel = document.querySelector('.file-btn');
            if (fileLabel) {
                fileLabel.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); videoFile.click(); } });
            }
        }
        let overlayTimer = null;
    let serverSavedVideoPath = null; // server-side filesystem path like './save/<file>'

        // --- VTT helpers ---
        function parseVttCues(vtt) {
            if (!vtt) return [];
            const lines = vtt.split(/\r?\n/);
            const cues = [];
            let i = 0;
            if (lines[i] && lines[i].startsWith('WEBVTT')) i++;
            while (i < lines.length) {
                while (i < lines.length && lines[i].trim() === '') i++;
                if (i >= lines.length) break;
                // skip numeric id
                if (lines[i] && !lines[i].includes('-->')) { i++; }
                if (i >= lines.length) break;
                const tl = lines[i] || '';
                const m = tl.match(/([0-9:.]+)\s*-->\s*([0-9:.]+)/);
                if (!m) { i++; continue; }
                const start = m[1], end = m[2];
                i++;
                const text = [];
                while (i < lines.length && lines[i].trim() !== '') { text.push(lines[i]); i++; }
                cues.push({ start, end, text: text.join('\n') });
            }
            return cues;
        }

        function parseTimeToSeconds(ts) {
            if (!ts) return 0;
            const p = ts.split(':').map(Number);
            if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
            if (p.length === 2) return p[0]*60 + p[1];
            return Number(ts) || 0;
        }

        function renderOverlayForTime(t) {
            const mode = subtitleModeSelect ? subtitleModeSelect.value : 'original';
            let vtt = '';
            if (mode === 'original') vtt = originalVtt;
            else if (mode === 'translated') vtt = translatedVtt;
            else vtt = originalVtt + '\n\n' + translatedVtt;
            const cues = parseVttCues(vtt);
            if (!cues || cues.length === 0) { subtitleOverlay.innerText = ''; return; }
            for (const c of cues) {
                const s = parseTimeToSeconds(c.start); const e = parseTimeToSeconds(c.end);
                if (t >= s && t <= e) { subtitleOverlay.innerText = c.text; return; }
            }
            subtitleOverlay.innerText = '';
        }

        function startOverlaySync() { stopOverlaySync(); overlayTimer = setInterval(()=>{ const t = (ytPlayer && ytPlayer.getCurrentTime) ? ytPlayer.getCurrentTime() : (videoPlayer.currentTime || 0); renderOverlayForTime(t); }, 200); subtitleOverlay.classList.remove('hidden'); }
        function stopOverlaySync() { if (overlayTimer) { clearInterval(overlayTimer); overlayTimer = null; } subtitleOverlay.classList.add('hidden'); subtitleOverlay.innerText = ''; }

        // --- YouTube preview ---
        const youtubeApiPromise = (function(){ let p=null; return function(){ if(p) return p; p = new Promise((resolve,reject)=>{ try{ if(window.YT && window.YT.Player) return resolve(window.YT); const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.head.appendChild(tag); window.onYouTubeIframeAPIReady = function(){ resolve(window.YT); }; setTimeout(()=>{ if(!window.YT) reject(new Error('YouTube API load timeout')); },10000); }catch(e){ reject(e);} }); return p; }; })();

        function getYouTubeIdFromUrl(url){ try{ const u = new URL(url); if (u.hostname.includes('youtube.com')) return new URLSearchParams(u.search).get('v'); if (u.hostname === 'youtu.be') return u.pathname.slice(1); }catch(e){} return null; }

        previewBtn.addEventListener('click', async (ev)=>{
            ev.preventDefault(); const url = (videoUrlInput||{}).value||''; if(!url) return alert('Please enter a YouTube URL'); const vid = getYouTubeIdFromUrl(url.trim()); if(!vid) return alert('Invalid YouTube URL'); try{ const YT = await youtubeApiPromise(); try{ if(ytPlayer && typeof ytPlayer.destroy === 'function') ytPlayer.destroy(); }catch(e){} const existing = document.getElementById('youtubeIframe'); if (existing) existing.remove(); videoPlayer.style.display='none'; const container = document.getElementById('playerContainer'); const div = document.createElement('div'); div.id='youtubeIframe'; div.style.width='100%'; div.style.height='480px'; container.appendChild(div); ytPlayer = new YT.Player('youtubeIframe',{ height:'480', width:'100%', videoId: vid, playerVars:{ playsinline:1, controls:1, rel:0, modestbranding:1 }, events:{ onReady:(e)=>{ startOverlaySync(); }, onStateChange:()=>{} } }); }catch(err){ alert('YouTube preview failed: ' + (err && err.message)); }
        });

        // --- Fetch button ---
        fetchBtn.addEventListener('click', async (e)=>{
            e.preventDefault(); const url = (videoUrlInput||{}).value||''; if(!url) return alert('Please enter a URL to fetch'); fetchBtn.disabled=true; try{ const resp = await fetch('/fetch',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url }) }); const data = await resp.json(); if (data.error) throw new Error(data.error||'Fetch failed'); const videoId = data.video_id; // poll status
                const poll = setInterval(async ()=>{ try{ const sresp = await fetch(`/fetch/status?video_id=${encodeURIComponent(videoId)}`); const sinfo = await sresp.json(); if (sinfo.status === 'Ready') { clearInterval(poll); fetchBtn.disabled=false; const path = sinfo.path; // path is a server filesystem path; expose public URL and remember server-side path
                            try { const fname = (path||'').split(/[\\/]/).pop(); if (fname) { serverSavedVideoPath = './save/' + fname; videoPlayer.style.display='block'; videoPlayer.src = '/save/' + fname; } else { videoPlayer.style.display='block'; videoPlayer.src = path; serverSavedVideoPath = null; } } catch(e) { videoPlayer.style.display='block'; videoPlayer.src = path; serverSavedVideoPath = null; }
                            document.getElementById('status').innerText = 'Fetch complete'; } else if (sinfo.status === 'Error') { clearInterval(poll); fetchBtn.disabled=false; document.getElementById('status').innerText = 'Fetch error'; alert('Fetch error: ' + (sinfo.error||'unknown')); } else { document.getElementById('status').innerText = sinfo.status; } }catch(err){ clearInterval(poll); fetchBtn.disabled=false; document.getElementById('status').innerText = 'Fetch polling failed'; } }, 1500);
            }catch(err){ fetchBtn.disabled=false; alert('Fetch start failed: ' + (err && err.message)); }
        });

        // --- Generate (extract + translate) ---
        async function uploadIfNeeded() {
            // If we have a previously fetched server-side path, use that (server filesystem path expected by /extract_async)
            if (serverSavedVideoPath) return serverSavedVideoPath;

            // If a file was chosen, upload it and return the server-side saved path
            if (videoFile && videoFile.files && videoFile.files.length > 0) {
                const f = videoFile.files[0];
                const fd = new FormData();
                fd.append('file', f);
                document.getElementById('status').innerText = 'Uploading file...';
                const upl = await fetch('/upload', { method: 'POST', body: fd });
                const j = await upl.json();
                if (j.error) throw new Error(j.error || 'Upload failed');
                return j.video_path;
            }

            // if videoPlayer.src is a local public URL (served from /save), try to convert to server filesystem path
            try {
                const src = videoPlayer && (videoPlayer.currentSrc || videoPlayer.src) || '';
                if (src && src.includes('/save/')) {
                    // public URL like /save/<file> -> server file path ./save/<file>
                    const fname = src.split('/').pop();
                    return './save/' + fname;
                }
            } catch(e){}
            return null;
        }

        async function pollExtractStatus(jobId) {
            return new Promise((resolve, reject) => {
                const iv = setInterval(async () => {
                    try {
                        const r = await fetch(`/extract/status?job_id=${encodeURIComponent(jobId)}`);
                        const info = await r.json();
                        if (info.error) { clearInterval(iv); return reject(new Error(info.error)); }
                        document.getElementById('status').innerText = info.message || info.state || 'Working';
                        // progress display when available
                        if (info.percent !== undefined && info.percent !== null) document.getElementById('status').innerText += ` (${info.percent}%)`;
                        if ((info.state && info.state === 'done') || (info.state && info.state === 'completed')) {
                            clearInterval(iv);
                            return resolve(info);
                        }
                        if (info.state && (info.state === 'error' || info.state === 'failed')) {
                            clearInterval(iv);
                            return reject(new Error(info.message || 'Extraction failed'));
                        }
                    } catch (err) {
                        clearInterval(iv);
                        return reject(err);
                    }
                }, 1500);
            });
        }

        generateBtn.addEventListener('click', async (ev)=>{
            ev.preventDefault();
            try {
                generateBtn.disabled = true;
                document.getElementById('status').innerText = 'Preparing extraction...';

                const videoPathFromUpload = await uploadIfNeeded();
                if (!videoPathFromUpload) {
                    generateBtn.disabled = false;
                    return alert('请先上传视频或使用 Fetch 下载一个视频，然后再生成字幕。');
                }

                const payload = {
                    video_path: videoPathFromUpload,
                    model: (modelSelect && modelSelect.value) ? modelSelect.value : 'tiny',
                    use_faster: !!(useFasterCheck && useFasterCheck.checked),
                    language: (sourceLangSelect && sourceLangSelect.value) ? sourceLangSelect.value : null
                };

                document.getElementById('status').innerText = 'Starting transcription job...';
                const resp = await fetch('/extract_async', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const j = await resp.json();
                if (j.error) throw new Error(j.error || 'Failed to start extraction');
                const jobId = j.job_id;
                document.getElementById('status').innerText = 'Job started. Polling status...';

                const final = await pollExtractStatus(jobId);
                // final may contain vtt_content and subtitles_path
                if (final && final.vtt_content) {
                    originalVtt = final.vtt_content;
                    originalSubtitles.value = originalVtt;
                    originalSubtitlesPane.innerText = originalVtt;
                    document.getElementById('status').innerText = 'Extraction complete';
                    // try translate
                    await translateIfRequested(originalVtt, videoPathFromUpload || serverSavedVideoPath);
                } else if (final && final.subtitles_path) {
                    // try to fetch file contents
                    try {
                        const got = await fetch(final.subtitles_path);
                            if (got.ok) {
                            const text = await got.text();
                            originalVtt = text;
                            originalSubtitles.value = text;
                            originalSubtitlesPane.innerText = text;
                            document.getElementById('status').innerText = 'Extraction complete';
                            await translateIfRequested(originalVtt, videoPathFromUpload || serverSavedVideoPath);
                        } else {
                            document.getElementById('status').innerText = 'Extraction complete (file saved)';
                        }
                    } catch (e) {
                        document.getElementById('status').innerText = 'Extraction complete (file saved)';
                    }
                } else {
                    document.getElementById('status').innerText = 'Extraction finished but no subtitles returned';
                }
            } catch (err) {
                console.error('Generate failed', err);
                alert('生成字幕失败: ' + (err && err.message));
                document.getElementById('status').innerText = 'Generate failed';
            } finally {
                generateBtn.disabled = false;
            }
        });

        // --- Subtitle style controls ---
        function applySubtitleStyles(){ const color = (subtitleColor && subtitleColor.value) || '#fff'; const size = (subtitleSize && subtitleSize.value) ? subtitleSize.value + 'px' : '24px'; subtitleOverlay.style.color = color; subtitleOverlay.style.fontSize = size; let style = document.getElementById('generatedCueStyle'); if(!style){ style = document.createElement('style'); style.id = 'generatedCueStyle'; document.head.appendChild(style); } style.innerHTML = `video::cue { color: ${color} !important; font-size: ${size} !important; text-shadow: 0 0 6px black !important; }`; }
        subtitleColor && subtitleColor.addEventListener('input', applySubtitleStyles); subtitleSize && subtitleSize.addEventListener('input', applySubtitleStyles); applySubtitleStyles();

        // --- Sync editable panes with textareas ---
        setInterval(()=>{ if (originalSubtitlesPane) originalSubtitles.value = originalSubtitlesPane.innerText || ''; if (translatedSubtitlesPane) translatedSubtitles.value = translatedSubtitlesPane.innerText || ''; }, 1200);

        // --- Download helpers ---
        function downloadVTT(filename, content){ const blob = new Blob([content||''], { type: 'text/vtt' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        downloadOriginalBtn.addEventListener('click', ()=>{ const fn = 'original.vtt'; downloadVTT(fn, originalSubtitles.value || originalSubtitlesPane.innerText); });
        downloadTranslatedBtn.addEventListener('click', ()=>{ const fn = 'translated.vtt'; downloadVTT(fn, translatedSubtitles.value || translatedSubtitlesPane.innerText); });

        // --- Models, languages and modal wiring ---
        async function refreshModelStatus() {
            try {
                const [statusResp, pairsResp] = await Promise.all([fetch('/models/status'), fetch('/translation_pairs')]);
                const statuses = await statusResp.json();
                const pairs = await pairsResp.json();

                // populate whisper models select
                modelSelect.innerHTML = '';
                if (statuses && statuses.whisper) {
                    Object.keys(statuses.whisper).forEach(m => modelSelect.add(new Option(m, m)));
                }

                // populate modal lists with current status and download buttons
                const whisperList = document.getElementById('whisperModelList');
                const translationList = document.getElementById('translationModelList');
                whisperList.innerHTML = '';
                translationList.innerHTML = '';

                if (statuses && statuses.whisper) {
                    for (const [m, st] of Object.entries(statuses.whisper)) {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between';
                        // show model name and status; add a small ready icon when Ready
                        const nameSpan = document.createElement('span');
                        nameSpan.innerHTML = `${m} <small class="text-slate-500">${st}</small>`;
                        li.appendChild(nameSpan);

                        const actionWrap = document.createElement('div');
                        actionWrap.className = 'model-action-group';

                        // if Ready, add a green badge
                        if (st && st.startsWith('Ready')) {
                            const badge = document.createElement('span');
                            badge.className = 'model-badge';
                            badge.innerHTML = `<svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="none"><path d="M0 0h24v24H0z"/></g><g fill="currentColor"><path d="M9.3 16.3L4.6 11.6l1.4-1.4 3.3 3.3 8.4-8.4 1.4 1.4-9.8 9.8z"/></g></svg><span>Ready</span>`;
                            actionWrap.appendChild(badge);
                        }

                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-sm rounded border flex items-center gap-2';
                        // configure visuals and dataset action
                        if (st && st.startsWith('Ready')) {
                            btn.dataset.action = 'remove';
                            btn.classList.add('bg-red-50', 'text-red-600', 'border-red-100');
                            btn.innerHTML = `
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="none"><path d="M3 6h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></g><g fill="currentColor"><path d="M9 6v12m6-12v12"/></g></svg>
                                <span>Remove</span>
                            `;
                        } else {
                            btn.dataset.action = 'download';
                            btn.classList.add('bg-blue-50', 'text-primary', 'border-blue-100');
                            btn.innerHTML = `
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></g><g fill="currentColor"><path d="M5 12l7 7 7-7"/></g></svg>
                                <span>Download</span>
                            `;
                        }

                        btn.addEventListener('click', async ()=>{
                            try {
                                btn.disabled = true;
                                if (btn.dataset.action === 'download') {
                                    await fetch('/models/download', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ model_type: 'whisper', model_key: m }) });
                                    setTimeout(refreshModelStatus, 1000);
                                } else {
                                    await fetch('/models/delete', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ model_type: 'whisper', model_key: m }) });
                                    setTimeout(refreshModelStatus, 500);
                                }
                            } catch (e) {
                                console.warn('Model action failed', e);
                                btn.disabled = false;
                            }
                        });

                        actionWrap.appendChild(btn);
                        li.appendChild(actionWrap);
                        whisperList.appendChild(li);
                    }
                }

                // translation model list from pairs
                const seenTranslationModels = {};
                if (pairs && Array.isArray(pairs)) {
                    pairs.forEach(p => { seenTranslationModels[p.model] = p; });
                }
                if (statuses && statuses.translation) {
                    for (const [m, st] of Object.entries(statuses.translation)) {
                        const info = seenTranslationModels[m] || { source: '?', target: '?', model: m };
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between';
                        const nameSpan = document.createElement('span');
                        nameSpan.innerHTML = `${m} <small class="text-slate-500">(${info.source}→${info.target}) ${st}</small>`;
                        li.appendChild(nameSpan);

                        const actionWrap = document.createElement('div');
                        actionWrap.className = 'model-action-group';

                        if (st && st.startsWith('Ready')) {
                            const badge = document.createElement('span');
                            badge.className = 'model-badge';
                            badge.innerHTML = `<svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="none"><path d="M0 0h24v24H0z"/></g><g fill="currentColor"><path d="M9.3 16.3L4.6 11.6l1.4-1.4 3.3 3.3 8.4-8.4 1.4 1.4-9.8 9.8z"/></g></svg><span>Ready</span>`;
                            actionWrap.appendChild(badge);
                        }

                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-sm rounded border flex items-center gap-2';
                        if (st && st.startsWith('Ready')) {
                            btn.dataset.action = 'remove';
                            btn.classList.add('bg-red-50', 'text-red-600', 'border-red-100');
                            btn.innerHTML = `
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="none"><path d="M3 6h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></g><g fill="currentColor"><path d="M9 6v12m6-12v12"/></g></svg>
                                <span>Remove</span>
                            `;
                        } else {
                            btn.dataset.action = 'download';
                            btn.classList.add('bg-blue-50', 'text-primary', 'border-blue-100');
                            btn.innerHTML = `
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden><g fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></g><g fill="currentColor"><path d="M5 12l7 7 7-7"/></g></svg>
                                <span>Download</span>
                            `;
                        }

                        btn.addEventListener('click', async ()=>{
                            try {
                                btn.disabled = true;
                                if (btn.dataset.action === 'download') {
                                    await fetch('/models/download', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ model_type: 'translation', model_key: m }) });
                                    setTimeout(refreshModelStatus, 1000);
                                } else {
                                    await fetch('/models/delete', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ model_type: 'translation', model_key: m }) });
                                    setTimeout(refreshModelStatus, 500);
                                }
                            } catch (e) {
                                console.warn('Model action failed', e);
                                btn.disabled = false;
                            }
                        });

                        actionWrap.appendChild(btn);
                        li.appendChild(actionWrap);
                        translationList.appendChild(li);
                    }
                } else {
                    // fill translation list from pairs if statuses not returned
                    Object.keys(seenTranslationModels).forEach(m=>{
                        const info = seenTranslationModels[m];
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between';
                        li.innerHTML = `<span>${m} <small class="text-slate-500">(${info.source}→${info.target})</small></span>`;
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-sm rounded border';
                        btn.innerText = 'Download';
                        btn.addEventListener('click', async ()=>{ btn.disabled=true; await fetch('/models/download', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ model_type: 'translation', model_key: m }) }); setTimeout(refreshModelStatus, 1000); });
                        li.appendChild(btn);
                        translationList.appendChild(li);
                    });
                }

                // populate language selectors
                const srcSet = new Set(); const tgtSet = new Set();
                if (pairs && Array.isArray(pairs)) {
                    pairs.forEach(p => { srcSet.add(p.source); tgtSet.add(p.target); });
                }
                // ensure sensible defaults
                const srcArr = Array.from(srcSet).sort(); const tgtArr = Array.from(tgtSet).sort();
                sourceLangSelect.innerHTML = ''; targetLangSelect.innerHTML = '';
                sourceLangSelect.add(new Option('Auto', ''));
                srcArr.forEach(l=> sourceLangSelect.add(new Option(l, l)));
                targetLangSelect.add(new Option('None', ''));
                tgtArr.forEach(l=> targetLangSelect.add(new Option(l, l)));

            } catch (err) {
                console.warn('Could not refresh model status or translation pairs', err);
            }
        }

        openModelModal.addEventListener('click', ()=>{ modelManagementModal.classList.remove('hidden'); refreshModelStatus(); });
        closeModelModal.addEventListener('click', ()=> modelManagementModal.classList.add('hidden'));
        closeModelModal2.addEventListener('click', ()=> modelManagementModal.classList.add('hidden'));

        // call once at load
        refreshModelStatus();

        // --- Translation helper ---
        async function translateIfRequested(vttContent, video_path) {
            try {
                const source = (sourceLangSelect && sourceLangSelect.value) || '';
                const target = (targetLangSelect && targetLangSelect.value) || '';
                if (!vttContent || !source || !target) return null;
                document.getElementById('status').innerText = 'Translating subtitles...';
                const resp = await fetch('/translate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ vtt_content: vttContent, source_lang: source, target_lang: target, video_path: video_path }) });
                const j = await resp.json();
                if (j.error) throw new Error(j.error || 'Translate failed');
                if (j.translated_vtt_content) {
                    translatedVtt = j.translated_vtt_content;
                    translatedSubtitles.value = translatedVtt;
                    translatedSubtitlesPane.innerText = translatedVtt;
                    document.getElementById('status').innerText = 'Translation complete';
                    return translatedVtt;
                }
                return null;
            } catch (err) {
                console.error('Translate failed', err);
                document.getElementById('status').innerText = 'Translate failed';
                return null;
            }
        }

        // Export some functions for debug/testing
        window.startOverlaySync = startOverlaySync;
        window.stopOverlaySync = stopOverlaySync;
        window.renderOverlayForTime = renderOverlayForTime;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
